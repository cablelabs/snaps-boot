# Copyright (c) 2019 Cable Television Laboratories, Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Ansible Playbook to run CI on EC2
---
- hosts: localhost

  gather_facts: no

  vars:
    run_build_var: "{{ run_build | default(true) }}"
    run_validation_var: "{{ run_validation | default(true) }}"
    destroy_var: "{{ destroy | default(true) }}"

  tasks:
    - name: Run build flag
      debug:
        var: run_build_var|bool
    - name: Run validation flag
      debug:
        var: run_validation_var|bool
    - name: Destroy flag
      debug:
        var: destroy_var|bool

    - name: Create Terraform binary directory
      file:
        path: "/tmp/{{ build_id}}/terraform-12.4"
        state: directory

    - name: Download Terraform
      unarchive:
        src: https://releases.hashicorp.com/terraform/0.12.4/terraform_0.12.4_linux_amd64.zip
        dest: "/tmp/{{ build_id}}/terraform-12.4"
        remote_src: yes

    - name: Create VM
      terraform:
        binary_path: "/tmp/{{ build_id}}/terraform-12.4/terraform"
        project_path: ./terraform
        variables_file: "{{ tf_var_file }}"
        force_init: true
        variables:
          build_id: "{{ build_id }}"
      register: tf_out
    - debug:
        var: tf_out

    - name: set pk file permissions to {{ tf_out.outputs.priv_key_file.value }}
      file:
        path: "{{ tf_out.outputs.priv_key_file.value }}"
        mode: 0600

    - name: Setup KVM
      shell: >-
        ansible-playbook ../playbooks/setup_kvm.yaml
        -i '{{ tf_out.outputs.pub_ip.value }},'
        -u {{ tf_out.outputs.sudo_user.value }}
        --key-file {{ tf_out.outputs.priv_key_file.value }}
        --extra-vars
        'priv_ip_prfx={{ priv_ip_prfx | default('10.0.1') }}
        admin_ip_prfx={{ admin_ip_prfx | default('10.0.2') }}
        pub_ip_prfx={{ pub_ip_prfx | default('10.0.3') }}'
      environment:
        ANSIBLE_HOST_KEY_CHECKING: "False"
      when: run_build_var|bool

    - name: Install snaps-boot
      shell: >-
        ansible-playbook ../playbooks/setup_build.yaml
        -i '{{ tf_out.outputs.pub_ip.value }},'
        -u {{ tf_out.outputs.sudo_user.value }}
        --key-file {{ tf_out.outputs.priv_key_file.value }}
        --extra-vars
        'build_id={{ build_id }}
        src_copy_dir={{ src_copy_dir }}
        post_script_file={{ src_copy_dir }}/snaps-boot/ci/scripts/post_script
        priv_ip_prfx={{ priv_ip_prfx | default('10.0.1') }}
        admin_ip_prfx={{ admin_ip_prfx | default('10.0.2') }}
        ip_suffix_1=11
        ip_suffix_2=12
        ip_suffix_3=13
        admin_mac_1={{ admin_mac_1 }}
        admin_mac_2={{ admin_mac_2 }}
        admin_mac_3={{ admin_mac_3 }}
        pub_ip_prfx={{ pub_ip_prfx | default('10.0.3') }}
        pub_gateway={{ pub_gateway }}
        broadcast_addr={{ broadcast_addr }}
        domain_name={{ domain_name | default('cablelabs.com') }}
        dns_addr={{ dns_addr | default('8.8.8.8') }}
        listen_iface={{ listen_iface | default('ens4') }}
        max_lease={{ max_lease | default('7200') }}
        netmask={{ netmask }}
        router_ip={{ router_ip }}
        build_admin_ip={{ build_admin_ip }}
        http_proxy_port={{ http_proxy_port | default('3142') }}
        priv_iface={{ priv_iface | default('eth0') }}
        admin_iface={{ admin_iface | default('eth1') }}
        pub_iface={{ admin_iface | default('eth2') }}
        pxe_pass={{ pxe_pass }}
        hosts_yaml_path={{ hosts_yaml_path }}'
      environment:
        ANSIBLE_HOST_KEY_CHECKING: "False"
      register: deploy_out
      ignore_errors: yes
      when: run_build_var|bool

    - name: k8s deploy out on failure
      debug:
        var: deploy_out.stdout_lines
      when: deploy_out is defined
    - fail:
      when: deploy_out is defined and deploy_out.rc is defined and deploy_out.rc != 0

#    - name: Destroy VM
#      terraform:
#        binary_path: "/tmp/{{ build_id}}/terraform-12.4/terraform"
#        project_path: ./terraform
#        variables_file: "{{ tf_var_file }}"
#        purge_workspace: yes
#        state: absent
#        variables:
#          build_id: "{{ build_id }}"
#      register: tf_destroy_out
#      when: destroy_var|bool
